!pip install transformers
!pip install sacremoses
!pip install torch
!pip install pandas
!pip install requests



# Step 0: Setup & Imports
import json
import pandas as pd
from transformers import AutoModelForCausalLM, AutoTokenizer
import requests

# Step 1: Load Patient Data from GitHub
patient_url = "https://raw.githubusercontent.com/springboardmentor545-lgtm/TeamB_EHR-Imaging-Documentation-System/main/Milestone%20-%203/patient_inputs.json"
icd_url = "https://raw.githubusercontent.com/springboardmentor545-lgtm/TeamB_EHR-Imaging-Documentation-System/main/Milestone%20-%203/Patient_ICD.json"

patients = requests.get(patient_url).json()
icd_data = requests.get(icd_url).json()

icd_map = {entry["Patient_ID"]: entry["ICD10_Code"] for entry in icd_data}


# Step 2: Load BioGPT Model
model_name = "microsoft/BioGPT-Large"
tokenizer = AutoTokenizer.from_pretrained(model_name)
model = AutoModelForCausalLM.from_pretrained(model_name)


# Step 3: Generate Clinical Notes
results = []

for patient in patients:
    pid = patient["Patient_ID"]
    age = patient["Age"]
    gender = patient["Gender"]
    symptoms = patient["Symptoms"]
    diagnosis = patient["Diagnosis"]

    prompt = (
        f"Patient: {age}-year-old {gender}\n"
        f"Symptoms: {symptoms}\n"
        f"Diagnosis: {diagnosis}\n\n"
        "Write a professional clinical note including Assessment and Plan."
    )

    inputs = tokenizer(prompt, return_tensors="pt")
    outputs = model.generate(**inputs, max_new_tokens=150)
    note = tokenizer.decode(outputs[0], skip_special_tokens=True)

    icd_code = icd_map.get(pid, "N/A")

    results.append({
        "Patient_ID": pid,
        "Age": age,
        "Gender": gender,
        "Symptoms": symptoms,
        "Diagnosis": diagnosis,
        "Clinical_Note": note,
        "ICD10_Code": icd_code
    })


# Step 4: Save to CSV
df = pd.DataFrame(results)
df.to_csv("generated_clinical_notes.csv", index=False)
print(" Clinical notes generated and saved to generated_clinical_notes.csv")
